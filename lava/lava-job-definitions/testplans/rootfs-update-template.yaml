{% extends "shared/templates/base.yaml" %}

{% set job_name = "RootFS Update"%}
{% set lxc_creation = true %}
{% set lxc_name = "rootfs-update-lxc" %}

{% block testplan %}
- test:
    timeout:
      minutes: 30
    namespace: lxc
    definitions:
    {% set venv_name = "/tmp/mbl-cli-provisioning-lxc" %}
    {% set venv_path = "/tmp/mbl-cli-provisioning-lxc/bin" %}

    {{ macros.mbl_avahi_discovery_test("pre") | indent }}

    {{ macros.install_mbl_cli(venv_name, venv_path) | indent }}

    {% set rootfs_test_stage = "UPDATE" %}
    {% set rootfs_update_method = "MBL_CLI" %}
    {{ macros.rootfs_update(rootfs_test_stage, image_url, rootfs_update_method, venv_path) | indent }}

- boot:
    namespace: target
    method: minimal
    auto_login:
        login_prompt: 'lava-mbed-linux-os-(.*) login:'
        username: 'root'
    prompts:
        - 'root@lava-mbed-linux-os-(.*):~#'
    timeout:
        minutes: 5
    failure-retry: 3

- test:
   timeout:
      minutes: 5
   namespace: lxc
   definitions:

    {% set rootfs_test_stage = "POST_CHECK" %}
    {% set rootfs_update_method = "MBL_CLI" %}
    {{ macros.rootfs_update(rootfs_test_stage, image_url, rootfs_update_method, venv_path) | indent }}

    {{ macros.mbl_avahi_discovery_test("post") | indent }}
{% endblock testplan %}
