{% extends "shared/templates/base.yaml" %}

{% set job_name = "Pelion RootFS Update" %}
{% set lxc_creation = true %}
{% set lxc_name = "pelion-rootfs-update-lxc" %}

{% block testplan %}
- test:
    timeout:
      minutes: 30
    namespace: lxc
    definitions:
    {{ macros.mbl_avahi_discovery_test("pre") | indent }}

    {{ macros.install_mbl_cli() | indent }}

    {{ macros.enable_wifi(device_type) | indent }}

    {{ macros.mbl_cli_provisioning() | indent }}

# Restart the mbl-cli-cloud-client
#
- test:
    timeout:
      minutes: 50
    namespace: target
    definitions:

    - from: inline
      repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: mbl-cloud-client-restart
          description: "mbl-cloud-client-restart"
        run:
          steps:
            - systemctl restart mbl-cloud-client
      name: mbl-cloud-client-restart
      path: inline/mbl-cloud-client-restart.yaml

- test:
   timeout:
      minutes: 10
   namespace: lxc
   definitions:
    - path: ci/lava/tests/mbl-cli-run-rootfs-test.yaml
      repository: https://github.com/ARMmbed/mbl-core.git
      name: run_rootfs_test_update
      from: git
      history: False
      branch: {{ mbl_branch }}
      parameters:
         test_stage: UPDATE
         image_url: {{ image_url }}
         pelion_update: PELION

    - path: ci/lava/tests/mbl-cli-run-rootfs-test.yaml
      repository: https://github.com/ARMmbed/mbl-core.git
      name: run_rootfs_test_post_check
      from: git
      history: False
      branch: {{ mbl_branch }}
      parameters:
         test_stage: POST_CHECK
         image_url: {{ image_url }}

    {{ macros.mbl_avahi_discovery_test("post") | indent }}

    {{ macros.delete_certificate() | indent }}

{% endblock testplan %}

