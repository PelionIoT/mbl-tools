{% extends "shared/templates/base.yaml" %}

{% set job_name = "Helloworld update via Pelion" %}
{% set lxc_creation = true %}
{% set lxc_name = "helloworld-update-lxc" %}

{% block testplan %}
- test:
    timeout:
      minutes: 50
    namespace: lxc
    definitions:

    {{ macros.avahi-discovery() | indent }}

    {{ macros.install-mbl-cli(venv_name) | indent }}

    {{ macros.enable-wifi(venv_name) | indent }}

    {{ macros.install-docker() | indent }}

    {{ macros.build-helloworld() | indent }}

    {{ macros.provision-mbl(venv_name) | indent }}

- test:
    timeout:
      minutes: 1
    namespace: target
    definitions:
    {{ macros.restart-mbl-cloud-client() | indent }}

- test:
    timeout:
      minutes: 10
    namespace: lxc
    definitions:
    - path: ci/lava/tests/helloworld-update-pelion.yaml
      repository: https://github.com/ARMmbed/mbl-core.git
      parameters:
          virtual_env: {{ venv_name }}
      name: helloworld-update-pelion
      from: git
      history: False
      branch: {{ mbl_branch }}
      {% if "mbl-core" in mbl_revisions %}
      revision: {{ mbl_revisions["mbl-core"] }}
      {% endif %}

    {{ macros.delete-certificate(venv_name) | indent }}

{% endblock testplan %}
