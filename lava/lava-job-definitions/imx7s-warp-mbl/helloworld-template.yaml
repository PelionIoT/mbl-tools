# Copyright (c) 2018, Arm Limited and Contributors. All rights reserved.
#
# SPDX-License-Identifier: BSD-3-Clause

device_type: imx7s-warp-mbl

job_name: MBL Hello World {{build_tag}}

timeouts:
  job:
    minutes: 100
  action:
    minutes: 50
  connection:
    minutes: 20
priority: medium
visibility: public

protocols:
  lava-lxc:
    name: hello-world-lxc
    template: ubuntu
    distribution: ubuntu
    release: xenial
    verbose: true

actions:

- deploy:
    namespace: target
    timeout:
      minutes: 50
    to: u-boot-ums
    os: oe
    image:
      url: {{ image_url }}
      compression: gz
      root_partition: 2

- boot:
    namespace: target
    method: u-boot
    commands: ums
    failure_retry: 5
    auto_login:
      login_prompt: 'mbed-linux-os-(.*) login:'
      username: 'root'
    prompts:
      - 'root@mbed-linux-os(.*):~#'
    timeout:
      minutes: 50

- deploy:
    namespace: lxc
    timeout:
      minutes: 5
    to: lxc
    os: ubuntu
    packages:
    - avahi-utils
    prompts:
      - 'root@hello-world-lxc-(.*):/#'

- boot:
    namespace: lxc
    method: lxc
    timeout:
      minutes: 20
    failure-retry: 3
    prompts:
      - 'root@hello-world-lxc-(.*):/#'


- test:
    timeout:
      minutes: 50
    namespace: lxc
    definitions:

    - path: ci/lava/dependencies/install_docker.yaml
      repository: https://github.com/ARMmbed/mbl-core.git
      name: install_docker
      from: git
      history: False
      branch: master

    - path: ci/lava/tests/lxc-build-helloworld.yaml
      repository: https://github.com/ARMmbed/mbl-core.git
      name: build_hello_world
      from: git
      history: False
      branch: master

    - path: ci/lava/dependencies/mbl-install-mbl-cli.yaml
      repository: https://github.com/ARMmbed/mbl-cli-python.git
      name: install_mbl_cli
      from: git
      history: False
      branch: master

    - path: ci/lava/tests/mbl-cli-run-helloworld.yaml
      repository: https://github.com/ARMmbed/mbl-core.git
      name: run_hello_world
      from: git
      history: False
      branch: master

metadata:
    build url: "{{ build_url }}"

{% if notify_user or notify_emails -%}
notify:
    recipients:
    {% if notify_user -%}
    - to:
       method: email
       user: {{ notify_user }}
    {% endif -%}
    {%- for email in notify_emails -%}
    - to:
       method: email
       email: {{ email }}
    {% endfor -%}
    criteria:
      status: finished
    verbosity: verbose
{% endif %}