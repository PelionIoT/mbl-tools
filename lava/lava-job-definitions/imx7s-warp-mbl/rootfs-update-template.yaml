{% extends "imx7s_warp_mbl_base.yaml" %}

{% set job_name = "RootFS Update"%}
{% set lxc_creation = true %}
{% set lxc_name = "rootfs-update-lxc" %}

{% block test %}
- test:
    timeout:
        minutes: 50
    namespace: lxc

    definitions:

    - from: inline
      repository:
          metadata:
              format: Lava-Test Test Definition 1.0
              name: ifconfig
              description: "LXC ifconfig"
          run:
              steps:
                 - ifconfig
                 - avahi-browse -v -t --all
      name: ifconfig
      path: inline/ifconfig.yaml

    - path: ci/lava/dependencies/mbl-install-mbl-cli.yaml
      repository: https://github.com/ARMmbed/mbl-cli-python.git
      name: install_mbl_cli
      from: git
      history: False
      branch: master

    - path: ci/lava/tests/mbl-cli-run-rootfs-test.yaml
      repository: https://github.com/ARMmbed/mbl-core.git
      name: run_rootfs_test_update
      from: git
      history: False
      branch: master
      parameters:
         test_stage: UPDATE
         image_url: {{ image_url }}

- boot:
    namespace: target
    method: minimal
    auto_login:
        login_prompt: 'lava-mbed-linux-os-(.*) login:'
        username: 'root'
    prompts:
        - 'root@lava-mbed-linux-os-(.*):~#'
    timeout:
        minutes: 20
    failure-retry: 3

- test:
   timeout:
      minutes: 50
   namespace: lxc
   definitions:
    - from: inline
      repository:
          metadata:
              format: Lava-Test Test Definition 1.0
              name: ifconfig
              description: "LXC ifconfig"
          run:
              steps:
                 - ifconfig
                 - avahi-browse -v -t --all
      name: ifconfig_part2
      path: inline/ifconfig_2.yaml

    - path: ci/lava/tests/mbl-cli-run-rootfs-test.yaml
      repository: https://github.com/ARMmbed/mbl-core.git
      name: run_rootfs_test_post_check
      from: git
      history: False
      branch: master
      parameters:
         test_stage: POST_CHECK
         image_url: {{ image_url }}

{% endblock test %}

